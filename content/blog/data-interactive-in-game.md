title: 网络游戏中的数据交互
d: data-interactive-in-game
date: 2012-11-17 09:49:33
tags: [game, json, protobuf, rpc, grpc, thrift] 
---
设计网络游戏，首先要面对的就是考虑如何实现客户端与服务端的数据交互。

这大体会涉及到两个方面的内容：

1. 客户端与服务器之间的通讯协议，
2. 通讯双方使用的数据交换格式

通讯协议常用的无外乎两种：1：TCP，2：HTTP

> 在一些即时战斗类或战网类游戏中可能还会涉及到客户端之间使用P2P方式连接，以及使用UDP进行传输

大体上，弱交互的游戏使用HTTP，强交互实时性较强的游戏使用TCP。

但这依赖于具体的使用场景还可以进一步划分，比如：

> 在一款实时战斗的手机游戏中，往往使用TCP进行连接，但是聊天功能由于在手机上使用不是很方便，所以聊天就变的弱交互了，因此聊天可以使用HTTP调用单独的聊天API。

**对于HTTP，常用的数据交换格式是：JSON或XML**

使用JSON/XML的优点是：
1. 使用方便
2. 内容自描述

缺点是：
1. 传输数据量大了点
2. Marshall和UnMarshall的时间长了一点

> 但无所谓，因为他们应用的场景本就是弱交互的环境，因此劣势比起优势可以忽略。

**但对于强交互游戏，数据交互格式就要好好选择了，特别地，在手机游戏中，如何最大限度的减少消息的大小是首要考虑的指标，这将会带来如下几个方面的收益：**

1. 节省用户流量，为用户省钱（土豪除外）
2. 省服务器带宽，为公司省钱
3. 提高了网络吞吐率（单台服务器网卡可以处理更多的消息）

讲了这么多前奏，该轮到大名鼎鼎的[protobuf](http://code.google.com/p/protobuf/)闪亮登场了，它的优点有：

* 名厂Google出品，有口皆碑，久经考验
* 数据压缩比高，满足我们指标要求
* 性能好，Google对性能的抠门程度不用我们担心
* 支持消息协议的向前和向后兼容（消息协议升级时，既有系统不会受到协议变更的影响）
* 多语言支持，如C++，Java，Python等（社区提供了非常多的对其他语言支持）
* 代码自动生成

如此多的特性非常适合在游戏应用！！！

#### 题外：

使用protobuf还有有另外一个好处，它自带提供对RPC的支持，这方便了内部系统之间的远程调用，但是遗憾的是之前并没有提供RPC的实现，这需要我们自己实现。这一点不像它的对手Thrift提供的全套的RPC解决方案。

> 自行实现基于Protobuf的RPC也不是很难的事，github上又很多基于Mina，Netty或ZeroMQ的实现，有兴趣可以自行去搜索。

幸运的是，Google最近刚刚开源了基于HTTP/2和ProtoBuf的通用RPC框架的gRPC，

请参见[这篇文章](http://www.infoq.com/cn/news/2015/03/grpc-google-http2-protobuf)中对gRPC的描述

gRPC的代码托管在Github上：[https://github.com/grpc/grpc](https://github.com/grpc/grpc)
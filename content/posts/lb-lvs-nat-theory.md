title: 负载均衡(1) - LVS/NAT原理
s: lb-vs-nat-1
date: 2008-08-19 16:21:25
tags: [linux, ipvs, lvs, load balancer]
---
### 工作原理

 VS/NAT（Virtual Server via Network Address Translation）的意思是“网络地址转换”，其原理是：调度器（也称之为：负载均衡器，Director等）收到来自客户端的“请求报文”后，根据指定的调度算法，将请求报文转发（负载分发）给隐藏在调度器后面的一组“真实服务器”（以下称RS）中的某台服务器去处理，当真实服务器处理完成后，又将报文发给Director，Director再一次修改IP数据包内种中的源地址和源端口，然后将响应报文发回给客户端，至此，完成整个负载分发过程。

很多硬件负载均衡设备就是基于NAT原理的。

### 基本要求

*   Director至少需要绑定两个IP（DIP和VIP），其中VIP是作为集群中对外服务的唯一接口；DIP用于连接内部RS服务器组，使调度器和RS服务器组连接在内部LAN中
*   调度器需要配置成可以转发IP数据报（设置ip_forward=1）
*   RS必须设置默认网关为DIP，以便响应报文能够发回到Director
*   RS和Director必须在同一个子网中，否则RS不能正确将响应报文发送到Director
*   如果Client和调度器位于同一网段，那么就不能使用VS/NAT模式，此时可配置成VS/DR模式。（请思考为什么？）

### 报文转发的详细处理流程

*   来自客户端的请求报文发送到调度器（通过VIP）
*   调度器网卡根据数据帧首部MAC地址发现是发给自己的，因此收下该数据帧并将其发给上层网卡驱动程序，网卡驱动去掉帧首部得到IP数据包内容并将其传给IP层处理。
*   IPVS模块通过调度算法（或从连接映射hash表中找到映射，如果之前已经映射过的话），得到一台真实服务器（Real Server / RS），假设为RS1。
*   修改IP数据报首部的“目标IP地址”和“目标端口”为RS1的IP和端口，然后将该数据包直接又发回给本机ARP模块处理
*   ARP模块为IP地址找到对应的mac地址（这里是RS1网卡所对应的MAC地址，关于ARP如何做地址映射可参考[W.Richard Stevens](http://baike.baidu.com/view/111783.htm)编写的《[TCP/IP详解-卷一](http://book.douban.com/subject/1088054/)》）
*   网卡驱动重新封装数据帧，并直接将数据帧发送到位于同一网络的RS1机器的网络接口卡
*   RS1收到从调度器发来的数据帧，发现目标mac地址是自己，同时IP数据包内容中的目标地址也是本主机地址，所以就会处理该报文并交由响应端口对应的应用程序去处理
*   当RS处理完成后，会设置响应报文中的“目标IP地址=CIP(CIP表示客户端IP), 源IP地址=RIP”，源端口=RS1的对应端口”
*   RS搜索本机路由表，发现CIP并不是一个直接相连的主机也不是位于同一共享网络中，因此使用默认路由(DIP)进行路由转发，此时响应报文被发送到DIP（即调度器的IP）。
*   调度器收到来自RS的响应报文，再次修改源IP地址为VIP以及源端口为调度器的端口，然后将报文重新发回给客户端

至此，对报文的完整流程处理结束!!!

> NOTE: 调度器不但会修改“目标IP”还会修改“目标端口”，因此该模式支持端口映射（其他模式不支持）

### 存在的问题及解决方案

#### 存在的问题

在VS/NAT工作模式中，请求报文和响应报文都要经过Director，因此Director将会成为整个集群的瓶颈，因此集群的吞吐量将受制于Director的处理速度以及Director服务器的出口带宽，由于IPVS工作在内核，处理速度非常高，因此调度器的主要瓶颈来自于调度器的网卡带宽上。

#### 解决方案

**方案1：**为应付流量增长，可以升级Director服务器的网卡为千兆网卡或万兆网卡，同时Director与RS连接的交换机也要换成千兆或万兆的。除此以外，还要考虑Director服务器的总线带宽，看操作系统以及服务器的硬件配置能否应付处理的了那么大的流量。

**方案2：**结合DNS-RR（DNS轮询策略）。将大的VS/NAT集群按照某种策略（如按地域或业务模块）划分成多个小的集群，结合DNS-RR组成两级负载均衡调度方式，由此每个小集群中的Director则只分担了部分流量。

**方案3：**考虑到多数应用请求报文小而响应报文大的这种**非对称性**特点，我们可以将VS/NAT模式换成VS/DR模式，这将会极大的提升调度器的吞吐率。
